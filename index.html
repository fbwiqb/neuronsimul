import React, { useState } from 'react';
import {
  LineChart, Line, XAxis, YAxis, Tooltip, CartesianGrid, ResponsiveContainer, ReferenceDot, Label, ReferenceLine
} from 'recharts';

const createMembraneData = (delay) => {
  const data = [];
  for (let t = 0; t <= 8; t += 0.1) {
    let v = -70;
    const localT = t - delay;
    if (localT >= 0 && localT < 1.0) {
      v = -70 + (localT / 1.0) * 20; // -70 â†’ -50
    } else if (localT >= 1.0 && localT < 1.5) {
      v = -50 + ((localT - 1.0) / 0.5) * 50; // -50 â†’ 0
    } else if (localT >= 1.5 && localT < 2.0) {
      v = 0 + ((localT - 1.5) / 0.5) * 30; // 0 â†’ +30
    } else if (localT >= 2.0 && localT < 2.5) {
      v = 30 - ((localT - 2.0) / 0.5) * 30; // +30 â†’ 0
    } else if (localT >= 2.5 && localT < 3.0) {
      v = 0 - ((localT - 2.5) / 0.5) * 80; // 0 â†’ -80
    } else if (localT >= 3.0 && localT <= 4.0) {
      v = -80 + ((localT - 3.0) / 1.0) * 10; // -80 â†’ -70
    }
    data.push({ time: parseFloat(t.toFixed(1)), voltage: parseFloat(v.toFixed(1)) });
  }
  return data;
};

const Graph = ({ label, delay, currentTime, visible, time, speed, distances }) => {
  if (!visible) return null;
  const data = createMembraneData(delay);
  const current = data.find((d, i, arr) => currentTime <= d.time || i === arr.length - 1) || { time: currentTime, voltage: -70 };

  const getBorderColor = (voltage) => {
    if (voltage > 0) return '#dc3545';
    if (voltage > -50) return '#fd7e14';
    if (voltage > -75) return '#6c757d';
    return '#0066cc';
  };

  return (
    <div style={{
      width: '48%',
      height: 380,
      margin: '1%',
      border: '3px solid',
      borderColor: getBorderColor(current.voltage),
      backgroundColor: '#fff',
      borderRadius: 12,
      padding: 15,
      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
      transition: 'all 0.3s ease'
    }}>
      <h4 style={{ 
        margin: '0 0 10px 0', 
        textAlign: 'center',
        fontSize: '18px',
        color: '#2c3e50',
        borderBottom: `2px solid ${getBorderColor(current.voltage)}`,
        paddingBottom: '8px'
      }}>
        ğŸ“ {label}
      </h4>
      <div style={{ 
        textAlign: 'center', 
        fontSize: '14px', 
        marginBottom: 8,
        backgroundColor: '#f8f9fa',
        padding: '8px',
        borderRadius: '6px'
      }}>
        í˜„ì¬ ë§‰ì „ìœ„: <strong style={{ 
          fontSize: '16px',
          color: getBorderColor(current.voltage)
        }}>{current.voltage} mV</strong><br/>
        ìê·¹ í›„ ê²½ê³¼ ì‹œê°„: <strong style={{ color: '#495057' }}>
          {currentTime >= delay ? `${(currentTime - delay).toFixed(1)} ms` : 'ë„ë‹¬ ì „'}
        </strong>
      </div>
      <ResponsiveContainer width="100%" height="70%">
        <LineChart data={data} margin={{ top: 5, right: 20, left: 10, bottom: 25 }}>
          <defs>
            <linearGradient id={`gradient-${label}`} x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stopColor="#0066cc" />
              <stop offset="25%" stopColor="#6c757d" />
              <stop offset="50%" stopColor="#fd7e14" />
              <stop offset="75%" stopColor="#dc3545" />
              <stop offset="100%" stopColor="#0066cc" />
            </linearGradient>
            <filter id={`glow-${label}`}>
              <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          <CartesianGrid strokeDasharray="3 3" stroke="#e9ecef" strokeOpacity={0.5} />
          <XAxis 
            dataKey="time" 
            ticks={[0, 1, 2, 3, 4, 5, 6, 7, 8]}
            stroke="#6c757d"
            style={{ fontSize: '12px' }}
          >
            <Label value="ì‹œê°„(ms)" position="insideBottomRight" offset={-5} style={{ fill: '#495057' }} />
          </XAxis>
          <YAxis 
            domain={[-100, 50]} 
            ticks={[-80, -70, 0, 30]}
            stroke="#6c757d"
            style={{ fontSize: '12px' }}
          >
            <Label value="ë§‰ì „ìœ„(mV)" angle={-90} position="insideLeft" style={{ fill: '#495057' }} />
          </YAxis>
          <Tooltip 
            formatter={(value) => [`${value} mV`, 'ë§‰ì „ìœ„']}
            contentStyle={{ 
              backgroundColor: 'rgba(255,255,255,0.95)', 
              border: '2px solid',
              borderColor: getBorderColor(current.voltage),
              borderRadius: '6px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
            }}
            labelStyle={{ fontWeight: 'bold' }}
          />
          <Line 
            type="monotone" 
            dataKey="voltage" 
            stroke="#2563eb"
            strokeWidth={3}
            dot={false}
          />
          <ReferenceDot 
            x={currentTime} 
            y={current.voltage} 
            r={8}
            fill={getBorderColor(current.voltage)}
            stroke="#fff"
            strokeWidth={3}
          >
            <animate attributeName="r" values="6;10;6" dur="1.5s" repeatCount="indefinite" />
          </ReferenceDot>
          <ReferenceLine y={-70} stroke="#6c757d" strokeDasharray="5 5" strokeOpacity={0.5}>
            <Label value="íœ´ì§€ì „ìœ„" position="right" style={{ fill: '#6c757d', fontSize: '11px' }} />
          </ReferenceLine>
          <ReferenceLine y={-80} stroke="#0066cc" strokeDasharray="5 5" strokeOpacity={0.5}>
            <Label value="ê³¼ë¶„ê·¹" position="right" style={{ fill: '#0066cc', fontSize: '11px' }} />
          </ReferenceLine>
          <ReferenceLine y={30} stroke="#dc3545" strokeDasharray="5 5" strokeOpacity={0.5}>
            <Label value="í”¼í¬" position="right" style={{ fill: '#dc3545', fontSize: '11px' }} />
          </ReferenceLine>
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
};

function App() {
  const [speed, setSpeed] = useState(2);
  const [time, setTime] = useState(0);
  const [visibleGraphs, setVisibleGraphs] = useState([true, true, true, true]);

  const distances = [0, 2, 4, 6];
  const dPercents = [20, 40, 60, 80];

  // ì—°ì†ì ì¸ ìœ„ì¹˜ ê³„ì‚°
  const totalLength = 6; // cm
  const xStart = 20;
  const xEnd = 90;
  const xRange = xEnd - xStart;
  const excitable = Math.min(time * speed, totalLength);
  const sparkStartPercent = 20;
  const sparkEndPercent = 80;
  const sparkRange = sparkEndPercent - sparkStartPercent;
  const sparkX = sparkStartPercent + (excitable / totalLength) * sparkRange;

  return (
    <div style={{ padding: 20, maxWidth: '1400px', margin: '0 auto', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' }}>
      <h2 style={{ textAlign: 'center', fontSize: '28px', marginBottom: '30px' }}>
        ğŸ§  ì‹ ê²½ì„¸í¬ ë§‰ì „ìœ„ ì‹œë®¬ë ˆì´í„°
      </h2>

      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 20, backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '8px' }}>
        <div style={{ flex: 1 }}>
          <label style={{ fontSize: '16px', fontWeight: '600' }}>âš¡ ì „ë„ ì†ë„ (cm/ms): </label>
          <input
            type="number"
            step="0.1"
            value={speed}
            onChange={e => setSpeed(parseFloat(e.target.value))}
            style={{ marginLeft: 10, padding: '6px 10px', borderRadius: 4, border: '2px solid #dee2e6', fontSize: '15px', fontWeight: '500' }}
          />
        </div>

        <div style={{ display: 'flex', gap: '15px' }}>
          <span style={{ fontSize: '16px', fontWeight: '600', marginRight: '10px' }}>ğŸ“Š ê·¸ë˜í”„ í‘œì‹œ:</span>
          {distances.map((d, i) => (
            <label key={i} style={{ cursor: 'pointer', fontSize: '15px' }}>
              <input
                type="checkbox"
                checked={visibleGraphs[i]}
                onChange={() => {
                  const newVis = [...visibleGraphs];
                  newVis[i] = !newVis[i];
                  setVisibleGraphs(newVis);
                }}
                style={{ marginRight: 5, width: '16px', height: '16px' }}
              /> 
              <span style={{ fontWeight: visibleGraphs[i] ? '600' : '400' }}>{d}cm</span>
            </label>
          ))}
        </div>
      </div>

      <div style={{ display: 'flex', gap: '20px', marginBottom: 20 }}>
        {/* ì™¼ìª½: ì‹œê°„ ìŠ¬ë¼ì´ë” */}
        <div style={{ flex: 1, backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '8px' }}>
          <label style={{ fontSize: '16px', fontWeight: '600' }}>â±ï¸ ì‹œê°„ (ms): 
            <span style={{ marginLeft: '10px', fontSize: '18px', color: '#007bff' }}>{time.toFixed(1)}</span>
          </label>
          <input
            type="range"
            min="0"
            max="8"
            step="0.1"
            value={time}
            onChange={e => setTime(parseFloat(e.target.value))}
            style={{ width: '100%', marginTop: 10, height: '8px' }}
          />
          <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '5px', fontSize: '12px', color: '#6c757d' }}>
            <span>0 ms</span>
            <span>2 ms</span>
            <span>4 ms</span>
            <span>6 ms</span>
            <span>8 ms</span>
          </div>
        </div>

        {/* ì˜¤ë¥¸ìª½: ë§‰ì „ìœ„ í‘œ */}
        <div style={{ border: '2px solid #dee2e6', backgroundColor: '#fff', padding: 15, borderRadius: 8, boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
          <h4 style={{ marginTop: 0, textAlign: 'center', fontSize: '16px', marginBottom: '10px' }}>
            ğŸ“ˆ ê° ì§€ì ì˜ ë§‰ì „ìœ„ (mV)
          </h4>
          <table style={{ borderCollapse: 'collapse', textAlign: 'center' }}>
            <thead>
              <tr>
                <th style={{ border: '2px solid #dee2e6', padding: '8px 12px', backgroundColor: '#e9ecef', fontWeight: '600', fontSize: '14px' }}>ì‹œê°„</th>
                {['dâ‚', 'dâ‚‚', 'dâ‚ƒ', 'dâ‚„'].map((d, i) => (
                  <th key={i} style={{ border: '2px solid #dee2e6', padding: '8px 12px', backgroundColor: '#e9ecef', fontWeight: '600', fontSize: '14px' }}>
                    {d} <span style={{ fontSize: '11px', fontWeight: '400' }}>({distances[i]}cm)</span>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style={{ border: '2px solid #dee2e6', padding: '8px 12px', fontWeight: 'bold', backgroundColor: '#f8f9fa', fontSize: '14px' }}>{time.toFixed(1)}</td>
                {distances.map((d, i) => {
                  const delay = d / speed;
                  const localT = time - delay;
                  let v = -70;
                  if (localT >= 0 && localT < 1.0) {
                    v = -70 + (localT / 1.0) * 20;
                  } else if (localT >= 1.0 && localT < 1.5) {
                    v = -50 + ((localT - 1.0) / 0.5) * 50;
                  } else if (localT >= 1.5 && localT < 2.0) {
                    v = 0 + ((localT - 1.5) / 0.5) * 30;
                  } else if (localT >= 2.0 && localT < 2.5) {
                    v = 30 - ((localT - 2.0) / 0.5) * 30;
                  } else if (localT >= 2.5 && localT < 3.0) {
                    v = 0 - ((localT - 2.5) / 0.5) * 80;
                  } else if (localT >= 3.0 && localT <= 4.0) {
                    v = -80 + ((localT - 3.0) / 1.0) * 10;
                  }
                  const color = v > -50 ? '#dc3545' : v < -70 ? '#0066cc' : '#212529';
                  const bgColor = v > 0 ? '#ffe4e6' : v < -70 ? '#e6f2ff' : '#fff';
                  return (
                    <td key={i} style={{ 
                      border: '2px solid #dee2e6', 
                      padding: '8px 12px', 
                      color, 
                      fontWeight: v > -50 ? 'bold' : '500',
                      backgroundColor: bgColor,
                      fontSize: '15px'
                    }}>
                      {v.toFixed(1)}
                    </td>
                  );
                })}
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div style={{ position: 'relative', width: '100%', height: 150, marginBottom: 20 }}>
        <svg width="100%" height="100%" viewBox="0 0 1000 150">
          {/* ìˆ˜ìƒëŒê¸° - ë°©ì‚¬í˜•ìœ¼ë¡œ */}
          <g id="dendrites" opacity="0.7">
            {/* ìœ„ìª½ */}
            <path d="M 100 45 L 100 25 M 100 25 L 95 15 M 100 25 L 105 15" stroke="#CD853F" strokeWidth="1.5" fill="none" />
            <path d="M 85 50 L 75 30 M 75 30 L 70 20 M 75 30 L 65 25" stroke="#CD853F" strokeWidth="1.5" fill="none" />
            <path d="M 115 50 L 125 30 M 125 30 L 130 20 M 125 30 L 135 25" stroke="#CD853F" strokeWidth="1.5" fill="none" />
            
            {/* ì™¼ìª½ */}
            <path d="M 70 75 L 50 75 M 50 75 L 40 70 M 50 75 L 40 80" stroke="#CD853F" strokeWidth="1.5" fill="none" />
            <path d="M 75 60 L 55 45 M 55 45 L 45 40 M 55 45 L 50 35" stroke="#CD853F" strokeWidth="1.5" fill="none" />
            <path d="M 75 90 L 55 105 M 55 105 L 45 110 M 55 105 L 50 115" stroke="#CD853F" strokeWidth="1.5" fill="none" />
            
            {/* ì•„ë˜ìª½ */}
            <path d="M 100 105 L 100 125 M 100 125 L 95 135 M 100 125 L 105 135" stroke="#CD853F" strokeWidth="1.5" fill="none" />
            <path d="M 85 100 L 75 120 M 75 120 L 70 130 M 75 120 L 65 125" stroke="#CD853F" strokeWidth="1.5" fill="none" />
            <path d="M 115 100 L 125 120 M 125 120 L 130 130 M 125 120 L 135 125" stroke="#CD853F" strokeWidth="1.5" fill="none" />
          </g>

          {/* ì„¸í¬ì²´ */}
          <circle cx="100" cy="75" r="30" fill="#FFE4B5" stroke="#8B4513" strokeWidth="2" />
          <circle cx="100" cy="75" r="10" fill="#CD853F" />
          
          {/* ì¶•ì‚­ (Axon) - ë” ê¸¸ê³  êµµê²Œ */}
          <rect x="130" y="65" width="750" height="20" fill="#FFE4B5" stroke="#8B4513" strokeWidth="1" />
          
          {/* ì¶•ì‚­ ë§ë‹¨ - ê°„ë‹¨í•˜ê²Œ */}
          <g id="axon-terminal">
            <path d="M 880 75 L 920 60" stroke="#8B4513" strokeWidth="2" fill="none" />
            <path d="M 880 75 L 920 75" stroke="#8B4513" strokeWidth="2" fill="none" />
            <path d="M 880 75 L 920 90" stroke="#8B4513" strokeWidth="2" fill="none" />
            <circle cx="920" cy="60" r="5" fill="#FFE4B5" stroke="#8B4513" strokeWidth="1" />
            <circle cx="920" cy="75" r="5" fill="#FFE4B5" stroke="#8B4513" strokeWidth="1" />
            <circle cx="920" cy="90" r="5" fill="#FFE4B5" stroke="#8B4513" strokeWidth="1" />
          </g>

          {/* ì¸¡ì • ì§€ì  í‘œì‹œ - ë” í¬ê³  ëª…í™•í•˜ê²Œ */}
          <text x="100" y="140" textAnchor="middle" fontSize="14" fontWeight="bold">ì„¸í¬ì²´</text>

          {/* d1~d4 ì§€ì  í‘œì‹œ */}
          {[0, 1, 2, 3].map((i) => {
            const xPos = 250 + (i * 180);
            return (
              <g key={i}>
                <line x1={xPos} y1="30" x2={xPos} y2="120" stroke="black" strokeWidth="2" strokeDasharray="5 3" />
                <text x={xPos} y="140" textAnchor="middle" fontSize="14" fontWeight="bold">{distances[i]}cm</text>
                <text x={xPos} y="20" textAnchor="middle" fontSize="16" fontWeight="bold">d<tspan dy="4" fontSize="12">{i + 1}</tspan></text>
              </g>
            );
          })}

          {/* í™œë™ì „ìœ„ ì‹ í˜¸ (ë²ˆê°œ) - d1(0cm)ì—ì„œ ì‹œì‘ */}
          {time * speed <= totalLength && (
            <g transform={`translate(${250 + (excitable / totalLength) * 540}, 75)`}>
              <circle r="20" fill="yellow" opacity="0.4" />
              <text fontSize="24" fill="gold" dominantBaseline="middle" textAnchor="middle">âš¡</text>
            </g>
          )}
        </svg>
      </div>



      <div style={{ display: 'flex', flexWrap: 'wrap', justifyContent: 'center' }}>
        {distances.map((d, i) => (
          <Graph
            key={i}
            label={`${d}cm ì§€ì `}
            delay={d / speed}
            currentTime={time}
            visible={visibleGraphs[i]}
            time={time}
            speed={speed}
            distances={distances}
          />
        ))}
      </div>
    </div>
  );
}

export default App;
